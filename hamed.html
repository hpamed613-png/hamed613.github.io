<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ø±Ø§Ù†ØªÙŠ Ø¨Ø±Ùˆ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root { --main-bg: #f8fafc; --royal-blue: #4f46e5; }
        body { font-family: 'Tajawal', sans-serif; background: var(--main-bg); color: #1e293b; margin: 0; padding: 0; overflow-x: hidden; }
        .royal-card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; transition: 0.3s; }
        .nav-link { color: #94a3b8; padding: 10px; border-radius: 15px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .nav-link.active { color: var(--royal-blue); background: #eef2ff; font-weight: bold; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆØ±Ù‚ */
        .invoice-paper { background: white; color: black; padding: 20px; width: 100%; max-width: 400px; margin: auto; border: 1px solid #ddd; box-shadow: 0 0 20px rgba(0,0,0,0.1); transition: all 0.3s; }
        .thermal-mode { max-width: 80mm; font-size: 12px; }
        .normal-mode { max-width: 800px; font-size: 16px; }

        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 1000; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; max-height: 200px; overflow-y: auto; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-weight: bold; }
        .suggestion-item:hover { background: #f8fafc; color: var(--royal-blue); }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; display: none; margin-bottom: 15px; border: 2px solid #4f46e5; }
        @media print { .no-print { display: none !important; } body { background: white; } .invoice-paper { box-shadow: none; border: none; } }
    </style>
</head>
<body class="pb-24">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 border-b border-slate-200 px-5 py-4 no-print">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg font-black italic">S</div>
                <h1 id="brand-name" class="text-lg font-black text-slate-800">Ø³Ø§Ø±Ø§Ù†ØªÙŠ Ø¨Ø±Ùˆ</h1>
            </div>
            <div class="flex gap-1">
                <button onclick="shareSystemData()" class="bg-blue-50 text-blue-600 px-2 py-2 rounded-lg text-[10px] font-bold border border-blue-100">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                <button onclick="downloadBackup()" class="bg-indigo-50 text-indigo-600 px-2 py-2 rounded-lg text-[10px] font-bold border border-indigo-100">Ø­ÙØ¸ Ù…Ù„Ù</button>
                <button onclick="copySystemData()" class="bg-emerald-50 text-emerald-600 px-2 py-2 rounded-lg text-[10px] font-bold border border-emerald-100">Ù†Ø³Ø®</button>
                <button onclick="importSystemData()" class="bg-amber-50 text-amber-600 px-2 py-2 rounded-lg text-[10px] font-bold border border-amber-100">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <button onclick="changeSettings()" class="bg-indigo-50 text-indigo-600 p-2 rounded-lg">âš™ï¸</button>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        
        <div id="tab-pos" class="tab-content space-y-4">
            <div id="reader"></div>

            <div class="space-y-2">
                <div class="royal-card p-3 relative">
                    <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†..." class="w-full p-2 rounded-xl border-none outline-none font-bold text-lg" onkeyup="showCustomerSuggestions(this.value)" autocomplete="off">
                    <div id="cust-sug-box" class="suggestions-box hidden"></div>
                </div>
                <div class="flex gap-2">
                    <input type="tel" id="cust-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨)..." class="royal-card flex-1 p-3 outline-none font-bold text-sm">
                    <button onclick="startScanner()" class="bg-indigo-600 text-white px-5 rounded-2xl shadow-lg">ğŸ“¸</button>
                </div>
            </div>

            <div id="cart-list" class="space-y-3"></div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="addCartRow()" class="p-4 royal-card font-black text-indigo-600 border-2 border-dashed border-indigo-200 bg-indigo-50/30">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                <div class="p-4 royal-card flex items-center justify-center font-bold text-slate-500">
                    <select id="unit" class="bg-transparent outline-none cursor-pointer">
                        <option>Ø§Ù„Ø¹Ø¯Ø¯</option><option>Ø§Ù„Ù…ØªØ±</option><option>Ø§Ù„ÙƒÙŠÙ„Ùˆ</option>
                    </select>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-300 mb-2 tracking-widest uppercase">Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø¢Ù†</p>
                        <input type="number" id="paid-amount" class="bg-transparent text-4xl font-black text-emerald-400 outline-none w-32 border-none" placeholder="0.00" oninput="calculateGrandTotal()">
                    </div>
                    <div class="text-left">
                        <p class="text-[10px] font-bold text-indigo-300 mb-2 tracking-widest uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                        <span id="total-display" class="text-5xl font-black">0.00</span>
                    </div>
                </div>
            </div>

            <button onclick="prepareInvoicePreview()" class="w-full bg-indigo-600 text-white p-5 rounded-[1.5rem] font-black text-xl shadow-xl">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ­ÙØ¸ âš¡</button>
            <button onclick="quickPayment()" class="w-full bg-emerald-50 text-emerald-700 p-4 rounded-xl font-bold border border-emerald-100 shadow-sm">ØªØ³Ø¬ÙŠÙ„ ÙˆØµÙ„ Ù‚Ø¨Ø¶ (Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†) ğŸ’¸</button>
        </div>

        <div id="tab-archive" class="tab-content hidden space-y-4">
            <div class="royal-card p-4 flex gap-2">
                <input type="text" id="search-arch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†..." class="flex-1 outline-none font-bold text-sm bg-transparent" oninput="renderArchive()">
                <span class="text-slate-400">ğŸ”</span>
            </div>
            <div id="archive-list" class="space-y-3"></div>
        </div>

        <div id="tab-debts" class="tab-content hidden space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="font-black text-slate-800">Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                <button onclick="shareDebtsBackup()" class="text-[10px] bg-rose-50 text-rose-600 p-2 rounded-lg font-bold border border-rose-100">Ù…Ø´Ø§Ø±ÙƒØ© Ù†Ø³Ø®Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
            </div>
            <div id="debts-list" class="space-y-3"></div>
        </div>

        <div id="tab-expenses" class="tab-content hidden space-y-4">
            <div class="royal-card p-6 space-y-4 border-t-4 border-rose-500">
                <h3 class="font-black text-slate-800">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="exp-title" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ" class="w-full p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                <input type="number" id="exp-val" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="w-full p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                <input type="date" id="exp-date" class="w-full p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                <button onclick="saveExpense()" class="w-full bg-rose-500 text-white p-4 rounded-xl font-black shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ±Ù ğŸ§¾</button>
            </div>
            <div id="expenses-list" class="space-y-2"></div>
        </div>

        <div id="tab-stock" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="royal-card p-5 bg-indigo-50 text-indigo-700">
                    <p class="text-[10px] font-black uppercase mb-1">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒØ§Ø´)</p>
                    <p id="stat-sales" class="text-2xl font-black">0.00</p>
                </div>
                <div class="royal-card p-5 bg-rose-50 text-rose-700">
                    <p class="text-[10px] font-black uppercase mb-1">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                    <p id="stat-expenses" class="text-2xl font-black">0.00</p>
                </div>
                <div class="royal-card p-5 bg-emerald-50 text-emerald-700">
                    <p class="text-[10px] font-black uppercase mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†</p>
                    <p id="stat-stock" class="text-2xl font-black">0.00</p>
                </div>
                <div class="royal-card p-5 bg-red-50 text-red-700">
                    <p class="text-[10px] font-black uppercase mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</p>
                    <p id="stat-debts" class="text-2xl font-black">0.00</p>
                </div>
            </div>

            <div class="royal-card p-6 space-y-4">
                <h3 class="font-black text-slate-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</h3>
                <input type="text" id="st-barcode" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                <input type="text" id="st-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" class="w-full p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="st-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" class="p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                    <input type="number" id="st-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" class="p-4 rounded-xl bg-slate-50 border outline-none font-bold">
                </div>
                <button onclick="addToStock()" class="w-full bg-slate-900 text-white p-4 rounded-xl font-black">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ğŸ“¦</button>
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <div class="text-center pb-4 no-print">
            <p style="color: red; font-size: 10px; font-weight: bold;">ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø­Ø§Ù…Ø¯ Ø§Ù„Ø¬Ù‡Ù…ÙŠ</p>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t p-3 flex justify-around shadow-2xl no-print">
        <button onclick="switchTab('pos')" id="nav-pos" class="nav-link active"><span>ğŸ’°</span><span class="text-[10px]">Ø§Ù„Ø¨ÙŠØ¹</span></button>
        <button onclick="switchTab('archive')" id="nav-archive" class="nav-link"><span>ğŸ“œ</span><span class="text-[10px]">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span></button>
        <button onclick="switchTab('debts')" id="nav-debts" class="nav-link"><span>ğŸ”´</span><span class="text-[10px]">Ø§Ù„Ø¯ÙŠÙˆÙ†</span></button>
        <button onclick="switchTab('expenses')" id="nav-expenses" class="nav-link"><span>ğŸ’¸</span><span class="text-[10px]">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></button>
        <button onclick="switchTab('stock')" id="nav-stock" class="nav-link"><span>ğŸ“Š</span><span class="text-[10px]">Ø§Ù„Ø¬Ø±Ø¯</span></button>
    </nav>

    <div id="invoice-modal" class="fixed inset-0 bg-black/90 hidden z-[100] p-4 flex flex-col items-center overflow-auto no-print">
        <div class="w-full max-w-md flex justify-between mb-4">
            <div class="flex gap-2">
                <button onclick="togglePaperSize('thermal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Ø­Ø±Ø§Ø±ÙŠ</button>
                <button onclick="togglePaperSize('normal')" class="bg-slate-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Ø¹Ø§Ø¯ÙŠ</button>
            </div>
            <button onclick="closeInvoice()" class="w-10 h-10 bg-white rounded-full font-bold">âœ•</button>
        </div>
        
        <div id="printable-area" class="invoice-paper rounded-lg thermal-mode">
            <div class="text-center border-b-2 border-slate-900 pb-4 mb-4">
                <h2 id="print-brand" class="text-xl font-black uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</h2>
                <p id="print-date" class="text-[10px] text-slate-500"></p>
            </div>
            
            <div class="space-y-1 mb-4 text-[11px] font-bold">
                <div class="flex justify-between"><span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <span id="print-cust"></span></div>
                <div class="flex justify-between"><span>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span> <span id="print-phone"></span></div>
                <div class="flex justify-between"><span>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span> <span id="print-inv-id"></span></div>
            </div>

            <table class="w-full text-right text-[11px] mb-4">
                <thead class="border-b border-slate-300">
                    <tr><th class="py-2">Ø§Ù„ØµÙ†Ù</th><th class="text-center">Ù‚</th><th class="text-center">Ø³Ø¹Ø±</th><th class="text-left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
                </thead>
                <tbody id="print-rows"></tbody>
            </table>

            <div class="border-t-2 border-slate-900 pt-3 space-y-1">
                <div class="flex justify-between font-bold text-xs"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span> <span id="print-total">0.00</span></div>
                <div class="flex justify-between text-[10px] text-emerald-600"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù†Ù‚Ø¯Ø§Ù‹:</span> <span id="print-paid">0.00</span></div>
                <div class="flex justify-between text-[10px] text-rose-600 border-b pb-2"><span>Ø¯ÙŠÙ† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> <span id="print-debt">0.00</span></div>
                <div class="mt-4 p-3 bg-slate-100 rounded-lg text-center border-2 border-slate-900">
                    <p class="text-[9px] font-black">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø²Ø¨ÙˆÙ†</p>
                    <p id="print-all-debts" class="text-xl font-black">0.00 Ø¯.Ù„</p>
                </div>
            </div>
        </div>

        <div class="mt-6 w-full max-w-md space-y-3">
            <button id="confirm-save-btn" onclick="confirmFinalSale()" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-black shadow-lg">Ø­ÙØ¸ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="window.print()" class="bg-emerald-600 text-white p-4 rounded-xl font-bold text-sm">Ø·Ø¨Ø§Ø¹Ø© ğŸ–¨ï¸</button>
                <button onclick="sendWhatsApp()" class="bg-green-600 text-white p-4 rounded-xl font-bold text-sm">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ“±</button>
            </div>
            <button onclick="downloadAsImage()" class="w-full bg-rose-600 text-white p-4 rounded-xl font-bold text-sm">ØªÙ†Ø²ÙŠÙ„ ÙƒØµÙˆØ±Ø© ğŸ–¼ï¸</button>
        </div>
    </div>

    <div id="hidden-backup" style="position: absolute; left: -9999px;"></div>

    <script>
        let stock = JSON.parse(localStorage.getItem('s_stock')) || [];
        let invoices = JSON.parse(localStorage.getItem('s_invoices')) || [];
        let expenses = JSON.parse(localStorage.getItem('s_expenses')) || [];
        let settings = JSON.parse(localStorage.getItem('s_settings')) || { brand: "Ø³Ø§Ø±Ø§Ù†ØªÙŠ Ø¨Ø±Ùˆ" };
        let customers = JSON.parse(localStorage.getItem('s_customers')) || {};

        window.onload = () => {
            document.getElementById('brand-name').innerText = settings.brand;
            addCartRow();
            updateStats();
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ---
        let html5QrCode;
        function startScanner() {
            document.getElementById('reader').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    const item = stock.find(s => s.barcode === decodedText);
                    if(item) {
                        addNewItemFromScanner(item);
                        html5QrCode.stop();
                        document.getElementById('reader').style.display = 'none';
                    } else {
                        alert("Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…Ø³Ø¬Ù„: " + decodedText);
                    }
                }
            ).catch(err => alert("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"));
        }

        function addNewItemFromScanner(item) {
            const id = Date.now() + Math.random();
            const div = document.createElement('div');
            div.className = "royal-card p-4 flex gap-3 items-center relative";
            div.id = `row-${id}`;
            div.innerHTML = `
                <div class="flex-1 space-y-2">
                    <input type="text" value="${item.name}" class="w-full font-black outline-none itm-name">
                    <div class="flex gap-2">
                        <input type="number" value="1" class="w-1/3 border-b p-1 font-bold itm-qty" oninput="calculateGrandTotal()">
                        <input type="number" value="${item.price}" class="w-2/3 border-b p-1 font-bold itm-price" oninput="calculateGrandTotal()">
                    </div>
                </div>
                <button onclick="removeRow('${id}')" class="text-rose-300 p-2 font-bold">âœ•</button>
            `;
            document.getElementById('cart-list').appendChild(div);
            calculateGrandTotal();
        }

        function addCartRow() {
            const id = Date.now() + Math.random();
            const div = document.createElement('div');
            div.className = "royal-card p-4 flex gap-3 items-center relative";
            div.id = `row-${id}`;
            div.innerHTML = `
                <div class="flex-1 space-y-2">
                    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù..." class="w-full font-black outline-none itm-name" onkeyup="searchProduct(this, '${id}')">
                    <div id="sug-${id}" class="suggestions-box hidden"></div>
                    <div class="flex gap-2">
                        <input type="number" placeholder="Ù‚" class="w-1/3 border-b p-1 font-bold itm-qty" oninput="calculateGrandTotal()">
                        <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-2/3 border-b p-1 font-bold itm-price" oninput="calculateGrandTotal()">
                    </div>
                </div>
                <button onclick="removeRow('${id}')" class="text-rose-300 p-2 font-bold">âœ•</button>
            `;
            document.getElementById('cart-list').appendChild(div);
        }

        function togglePaperSize(mode) {
            const el = document.getElementById('printable-area');
            if(mode === 'thermal') {
                el.classList.add('thermal-mode');
                el.classList.remove('normal-mode');
            } else {
                el.classList.remove('thermal-mode');
                el.classList.add('normal-mode');
            }
        }

        function removeRow(id) { document.getElementById(`row-${id}`).remove(); calculateGrandTotal(); }

        function searchProduct(el, rowId) {
            const val = el.value.toLowerCase();
            const box = document.getElementById('sug-' + rowId);
            if(!val) { box.classList.add('hidden'); return; }
            const matches = stock.filter(i => i.name.toLowerCase().includes(val) || (i.barcode && i.barcode.includes(val)));
            box.innerHTML = matches.map(m => `
                <div class="suggestion-item" onclick="selectProduct('${rowId}', '${m.name}', ${m.price})">
                    ${m.name} <span class="text-[10px] opacity-50">(${m.qty})</span>
                </div>`).join('');
            box.classList.remove('hidden');
        }

        function selectProduct(rowId, name, price) {
            const row = document.ge
